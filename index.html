<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ballin on a Budget</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    header {
      background: white;
      padding: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    header h1 {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
      text-align: center;
      font-size: 24px;
    }
    
    .tabs {
      display: flex;
      background: white;
      position: sticky;
      top: 64px;
      z-index: 99;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .tab {
      flex: 1;
      padding: 15px 10px;
      text-align: center;
      cursor: pointer;
      border: none;
      background: white;
      color: #666;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
    }
    
    .tab:hover {
      background: #f8f9ff;
    }
    
    .tab.active {
      color: #667eea;
      border-bottom: 3px solid #667eea;
    }
    
    .tab-content {
      display: none;
      padding: 20px;
      animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .card h3 {
      margin-top: 0;
      color: #333;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .stat-box {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .stat-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .stat-value {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
    }
    
    input, select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 15px;
    }
    
    button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      margin-top: 10px;
    }
    
    button:hover {
      opacity: 0.9;
    }
    
    .hidden {
      display: none;
    }
    
    /* Auth Forms */
    .form-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      margin: 50px 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .form-container h2 {
      text-align: center;
      color: #333;
    }
    
    .toggle-link {
      text-align: center;
      margin-top: 15px;
      color: #667eea;
      cursor: pointer;
      text-decoration: underline;
    }
    
    .error {
      color: #dc3545;
      font-size: 14px;
      margin-top: 10px;
      text-align: center;
    }
    
    #logout-btn {
      background: #dc3545;
      margin: 10px 20px;
    }
    
    /* Transaction Items */
    .transaction-item {
      background: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-left: 4px solid transparent;
    }
    
    .transaction-item.income {
      border-left-color: #28a745;
    }
    
    .transaction-item.expense {
      border-left-color: #dc3545;
    }
    
    .transaction-details {
      flex: 1;
    }
    
    .transaction-category {
      font-size: 12px;
      color: #666;
      text-transform: capitalize;
    }
    
    .transaction-date {
      font-size: 12px;
      color: #999;
    }
    
    .transaction-amount {
      font-size: 18px;
      font-weight: bold;
    }
    
    .transaction-amount.income {
      color: #28a745;
    }
    
    .transaction-amount.expense {
      color: #dc3545;
    }
    
    /* Bill Items */
    .bill-item {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .bill-item.due-soon {
      border-left: 4px solid #FF9F40;
    }
    
    .bill-item.overdue {
      border-left: 4px solid #dc3545;
    }
    
    .bill-name {
      font-weight: bold;
      margin-bottom: 3px;
    }
    
    .bill-info {
      font-size: 12px;
      color: #666;
    }
    
    .bill-amount {
      font-size: 18px;
      font-weight: bold;
      color: #dc3545;
    }
    
    .bill-due {
      font-size: 12px;
      color: #999;
      margin-top: 3px;
    }
    
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    /* Legend Items */
    .legend-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .legend-item:last-child {
      border-bottom: none;
    }
    
    .legend-color {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      margin-right: 10px;
      flex-shrink: 0;
    }
    
    .legend-label {
      flex: 1;
      text-transform: capitalize;
    }
    
    .legend-amount {
      font-weight: bold;
      margin-left: 10px;
    }
    
    .legend-percentage {
      color: #666;
      font-size: 14px;
      margin-left: 5px;
    }
    
    /* Budget Progress */
    .budget-category-item {
      background: #f9f9f9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    
    .budget-progress-bar {
      background: #e0e0e0;
      border-radius: 4px;
      height: 20px;
      position: relative;
      overflow: hidden;
      margin-top: 5px;
    }
    
    .budget-progress-fill {
      height: 100%;
      transition: width 0.3s, background 0.3s;
      border-radius: 4px;
    }
    
    .budget-progress-fill.good {
      background: #28a745;
    }
    
    .budget-progress-fill.warning {
      background: #FF9F40;
    }
    
    .budget-progress-fill.over {
      background: #dc3545;
    }
  </style>
</head>
<body>

  <!-- Sign Up Form -->
  <div id="signup-form" class="form-container">
    <h2>Sign Up</h2>
    <input type="email" id="signup-email" placeholder="Email" required>
    <input type="password" id="signup-password" placeholder="Password (min 6 characters)" required>
    <button id="signup-btn">Sign Up</button>
    <div id="signup-error" class="error"></div>
    <div class="toggle-link" id="show-login">Already have an account? Login</div>
  </div>

  <!-- Login Form -->
  <div id="login-form" class="form-container hidden">
    <h2>Login</h2>
    <input type="email" id="login-email" placeholder="Email" required>
    <input type="password" id="login-password" placeholder="Password" required>
    <button id="login-btn">Login</button>
    <div id="login-error" class="error"></div>
    <div class="toggle-link" id="show-signup">Don't have an account? Sign Up</div>
  </div>

  <!-- Household Setup -->
  <div id="household-setup" class="form-container hidden">
    <h2>Set Up Your Household</h2>
    <p style="text-align: center; color: #666;">Create a new household or join an existing one</p>
    <button id="show-create-household">Create New Household</button>
    <button id="show-join-household" style="background: #28a745;">Join Existing Household</button>
    <button id="logout-btn-setup" style="background: #dc3545;">Logout</button>
  </div>

  <!-- Create Household Form -->
  <div id="create-household-form" class="form-container hidden">
    <h2>Create Household</h2>
    <input type="text" id="household-name" placeholder="Household Name" required>
    <button id="create-household-btn">Create Household</button>
    <div id="create-household-error" class="error"></div>
    <div class="toggle-link" id="back-to-household-setup">Back</div>
  </div>

  <!-- Join Household Form -->
  <div id="join-household-form" class="form-container hidden">
    <h2>Join Household</h2>
    <input type="text" id="join-code" placeholder="6-digit invite code" required maxlength="6">
    <button id="join-household-btn">Join Household</button>
    <div id="join-household-error" class="error"></div>
    <div class="toggle-link" id="back-to-household-setup-2">Back</div>
  </div>

  <!-- Main App (with tabs) -->
  <div id="main-app" class="hidden">
    <header>
      <h1>Ballin on a Budget</h1>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="showTab('dashboard')">ðŸ“Š Dashboard</button>
      <button class="tab" onclick="showTab('transactions')">ðŸ’³ Transactions</button>
      <button class="tab" onclick="showTab('bills')">ðŸ“… Bills</button>
      <button class="tab" onclick="showTab('budget')">ðŸŽ¯ Budget</button>
    </div>

    <!-- Dashboard Tab -->
    <div id="dashboard" class="tab-content active">
      <div class="card">
        <h3>Spending by Category</h3>
        <canvas id="category-pie-chart" style="max-height: 300px; margin-bottom: 20px;"></canvas>
        <div id="category-chart"></div>
      </div>
      
      <div class="card">
        <h3>Quick Overview</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Fixed Bills</div>
            <div class="stat-value" style="color: #dc3545;" id="dashboard-fixed-bills">$0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Discretionary</div>
            <div class="stat-value" style="color: #FF9F40;" id="dashboard-discretionary">$0</div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <h3>Monthly Budget</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">Income</div>
            <div class="stat-value" style="color: #28a745;" id="dashboard-income">$0</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Leftover</div>
            <div class="stat-value" style="color: #28a745;" id="dashboard-leftover">$0</div>
          </div>
        </div>
        <div class="budget-progress-bar" style="margin-top: 10px;">
          <div id="dashboard-progress-bar" class="budget-progress-fill good" style="width: 0%"></div>
        </div>
        <div style="font-size: 12px; color: #666; margin-top: 5px; text-align: center;" id="dashboard-progress-text">0% spent</div>
      </div>
      
      <div class="card">
        <h3>Upcoming Bills</h3>
        <div id="upcoming-bills-preview"></div>
      </div>
      
      <div class="card">
        <h3>Household Info</h3>
        <p style="margin: 5px 0;"><strong>Name:</strong> <span id="current-household-name"></span></p>
        <p style="margin: 5px 0;"><strong>Invite Code:</strong> <span id="household-invite-code" style="font-family: monospace; background: #f0f0f0; padding: 2px 6px; border-radius: 4px;"></span></p>
        <button id="logout-btn">Logout</button>
      </div>
    </div>

    <!-- Transactions Tab -->
    <div id="transactions" class="tab-content">
      <div class="card">
        <h3>Add Transaction</h3>
        <select id="transaction-type">
          <option value="expense">Expense</option>
          <option value="income">Income</option>
        </select>
        <input type="number" id="transaction-amount" placeholder="Amount" step="0.01" required>
        <select id="transaction-category">
          <option value="">Select Category</option>
          <option value="groceries">Groceries</option>
          <option value="dining">Dining</option>
          <option value="utilities">Utilities</option>
          <option value="rent">Rent</option>
          <option value="transportation">Transportation</option>
          <option value="entertainment">Entertainment</option>
          <option value="healthcare">Healthcare</option>
          <option value="shopping">Shopping</option>
          <option value="subscriptions">Subscriptions</option>
          <option value="other">Other</option>
        </select>
        <input type="text" id="transaction-description" placeholder="Description (optional)">
        <input type="date" id="transaction-date" required>
        <button id="add-transaction-btn">Add Transaction</button>
        <div id="transaction-error" class="error"></div>
      </div>
      
      <div class="card">
        <h3>Recent Transactions</h3>
        <div id="transactions-list"></div>
      </div>
    </div>

    <!-- Bills Tab -->
    <div id="bills" class="tab-content">
      <div class="card">
        <h3>Recurring Bills</h3>
        <div id="recurring-bills-list"></div>
      </div>
      
      <div class="card">
        <h3>Add Recurring Bill</h3>
        <input type="text" id="bill-name" placeholder="Bill Name" required>
        <input type="number" id="bill-amount" placeholder="Amount" step="0.01" required>
        <select id="bill-category">
          <option value="">Select Category</option>
          <option value="rent">Rent/Mortgage</option>
          <option value="utilities">Utilities</option>
          <option value="subscriptions">Subscriptions</option>
          <option value="other">Other</option>
        </select>
        <input type="number" id="bill-day" placeholder="Day of month (1-31)" min="1" max="31" required>
        <button id="add-bill-btn">Add Recurring Bill</button>
        <div id="bill-error" class="error"></div>
      </div>
    </div>

    <!-- Budget Tab -->
    <div id="budget" class="tab-content">
      <!-- Budget Overview (shown when budget exists) -->
      <div id="budget-overview">
        <div class="card">
          <h3>Budget Overview</h3>
          <div class="stats-grid">
            <div class="stat-box">
              <div class="stat-label">Income</div>
              <div class="stat-value" style="color: #28a745;" id="budget-income-display">$0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Spending</div>
              <div class="stat-value" style="color: #dc3545;" id="budget-spending-display">$0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">Leftover</div>
              <div class="stat-value" id="budget-leftover-display">$0</div>
            </div>
            <div class="stat-box">
              <div class="stat-label">% Spent</div>
              <div class="stat-value" id="overall-budget-percentage">0%</div>
            </div>
          </div>
          <div class="budget-progress-bar">
            <div id="overall-budget-bar" class="budget-progress-fill good" style="width: 0%"></div>
          </div>
        </div>
        
        <div class="card">
          <h3>Category Budgets</h3>
          <div id="category-budgets-list"></div>
        </div>
        
        <div class="card">
          <h3>Edit Budget</h3>
          <button id="edit-budget-btn">Edit Budget Settings</button>
        </div>
      </div>

      <!-- Budget Setup Form (shown when creating/editing budget) -->
      <div id="budget-setup-form" class="card hidden">
        <h3>Set Up Your Budget</h3>
        <input type="number" id="budget-income" placeholder="Monthly Income" step="0.01" required>
        <h4 style="margin: 20px 0 10px 0;">Category Limits (Optional)</h4>
        <div id="category-budget-inputs"></div>
        <button id="save-budget-btn">Save Budget</button>
        <div id="budget-error" class="error"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } 
      from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, query, where, getDocs, doc, getDoc, setDoc, deleteDoc, orderBy, limit } 
      from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBbyOgSbmwxhqYaoPih0v_PpKQK208u0zU",
      authDomain: "harris-house-ef670.firebaseapp.com",
      projectId: "harris-house-ef670",
      storageBucket: "harris-house-ef670.firebasestorage.app",
      messagingSenderId: "398594469140",
      appId: "1:398594469140:web:1bf73a98029f5800b06601"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM elements
    const signupForm = document.getElementById('signup-form');
    const loginForm = document.getElementById('login-form');
    const householdSetup = document.getElementById('household-setup');
    const createHouseholdForm = document.getElementById('create-household-form');
    const joinHouseholdForm = document.getElementById('join-household-form');
    const mainApp = document.getElementById('main-app');

    let currentBudget = null;

    // Tab switching function
    window.showTab = function(tabName) {
      const contents = document.querySelectorAll('.tab-content');
      contents.forEach(content => content.classList.remove('active'));
      
      const tabs = document.querySelectorAll('.tab');
      tabs.forEach(tab => tab.classList.remove('active'));
      
      document.getElementById(tabName).classList.add('active');
      event.target.classList.add('active');
    };

    // Toggle between signup and login
    document.getElementById('show-login').addEventListener('click', () => {
      signupForm.classList.add('hidden');
      loginForm.classList.remove('hidden');
    });

    document.getElementById('show-signup').addEventListener('click', () => {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
    });

    // Sign Up
    document.getElementById('signup-btn').addEventListener('click', async () => {
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const errorDiv = document.getElementById('signup-error');
      errorDiv.textContent = '';

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        console.log('User signed up:', userCredential.user.uid);
      } catch (error) {
        errorDiv.textContent = error.message;
      }
    });

    // Login
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorDiv = document.getElementById('login-error');
      errorDiv.textContent = '';

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log('User logged in:', userCredential.user.uid);
      } catch (error) {
        errorDiv.textContent = error.message;
      }
    });

    // Household setup navigation
    document.getElementById('show-create-household').addEventListener('click', () => {
      householdSetup.classList.add('hidden');
      createHouseholdForm.classList.remove('hidden');
    });

    document.getElementById('show-join-household').addEventListener('click', () => {
      householdSetup.classList.add('hidden');
      joinHouseholdForm.classList.remove('hidden');
    });

    document.getElementById('back-to-household-setup').addEventListener('click', () => {
      createHouseholdForm.classList.add('hidden');
      householdSetup.classList.remove('hidden');
    });

    document.getElementById('back-to-household-setup-2').addEventListener('click', () => {
      joinHouseholdForm.classList.add('hidden');
      householdSetup.classList.remove('hidden');
    });

    // Generate random 6-digit code
    function generateInviteCode() {
      return Math.floor(100000 + Math.random() * 900000).toString();
    }

    // Create household
    document.getElementById('create-household-btn').addEventListener('click', async () => {
      const householdName = document.getElementById('household-name').value;
      const errorDiv = document.getElementById('create-household-error');
      errorDiv.textContent = '';

      if (!householdName) {
        errorDiv.textContent = 'Please enter a household name';
        return;
      }

      try {
        const user = auth.currentUser;
        const inviteCode = generateInviteCode().toUpperCase();

        console.log('Creating household with invite code:', inviteCode);

        const householdData = {
          name: householdName,
          inviteCode: inviteCode,
          createdBy: user.uid,
          createdAt: new Date().toISOString(),
          members: [user.uid]
        };

        const householdRef = await addDoc(collection(db, 'households'), householdData);

        await setDoc(doc(db, 'users', user.uid), {
          householdId: householdRef.id,
          joinedAt: new Date().toISOString()
        });

        console.log('Household created successfully:', householdRef.id, 'Invite code:', inviteCode);
        window.location.reload();
      } catch (error) {
        console.error('Create household error:', error);
        errorDiv.textContent = 'Error creating household: ' + error.message;
      }
    });

    // Join household
    document.getElementById('join-household-btn').addEventListener('click', async () => {
      const inviteCode = document.getElementById('join-code').value.trim().toUpperCase();
      const errorDiv = document.getElementById('join-household-error');
      errorDiv.textContent = '';

      if (!inviteCode || inviteCode.length !== 6) {
        errorDiv.textContent = 'Please enter a valid 6-character code';
        return;
      }

      try {
        const user = auth.currentUser;

        // Check if user already has a household
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        if (userDoc.exists() && userDoc.data().householdId) {
          errorDiv.textContent = 'You already belong to a household. Please logout and create a new account to join a different household.';
          return;
        }

        console.log('Searching for household with invite code:', inviteCode);

        const q = query(collection(db, 'households'), where('inviteCode', '==', inviteCode));
        const querySnapshot = await getDocs(q);

        console.log('Query results:', querySnapshot.size, 'households found');

        if (querySnapshot.empty) {
          errorDiv.textContent = 'Invalid invite code. Please check and try again.';
          return;
        }

        const householdDoc = querySnapshot.docs[0];
        const householdData = householdDoc.data();

        console.log('Found household:', householdData.name);

        // Check if user is already a member
        if (householdData.members && householdData.members.includes(user.uid)) {
          errorDiv.textContent = 'You are already a member of this household';
          return;
        }

        const updatedMembers = householdData.members ? [...householdData.members, user.uid] : [user.uid];
        await setDoc(householdDoc.ref, { members: updatedMembers }, { merge: true });

        await setDoc(doc(db, 'users', user.uid), {
          householdId: householdDoc.id,
          joinedAt: new Date().toISOString()
        });

        console.log('Successfully joined household:', householdDoc.id);
        alert('Successfully joined ' + householdData.name + '!');
        window.location.reload();
      } catch (error) {
        console.error('Join household error:', error);
        errorDiv.textContent = 'Error joining household: ' + error.message;
      }
    });

    // Logout buttons
    document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
    document.getElementById('logout-btn-setup').addEventListener('click', () => signOut(auth));

    // Get user's household ID
    async function getUserHousehold(userId) {
      try {
        const userDoc = await getDoc(doc(db, 'users', userId));
        if (userDoc.exists()) {
          return userDoc.data().householdId;
        }
        return null;
      } catch (error) {
        console.error('Error getting user household:', error);
        return null;
      }
    }

    // Load household data
    async function loadHouseholdData(householdId) {
      try {
        const householdDoc = await getDoc(doc(db, 'households', householdId));
        if (householdDoc.exists()) {
          return householdDoc.data();
        }
        return null;
      } catch (error) {
        console.error('Error loading household:', error);
        return null;
      }
    }

    // Set today's date as default
    document.getElementById('transaction-date').valueAsDate = new Date();

    // Add transaction
    document.getElementById('add-transaction-btn').addEventListener('click', async () => {
      const type = document.getElementById('transaction-type').value;
      const amount = document.getElementById('transaction-amount').value;
      const category = document.getElementById('transaction-category').value;
      const description = document.getElementById('transaction-description').value;
      const date = document.getElementById('transaction-date').value;
      const errorDiv = document.getElementById('transaction-error');
      errorDiv.textContent = '';

      if (!amount || !category || !date) {
        errorDiv.textContent = 'Please fill in all required fields';
        return;
      }

      if (parseFloat(amount) <= 0) {
        errorDiv.textContent = 'Amount must be greater than 0';
        return;
      }

      try {
        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const householdId = userDoc.data().householdId;

        const transactionData = {
          householdId: householdId,
          userId: user.uid,
          type: type,
          amount: parseFloat(amount),
          category: category,
          description: description,
          date: date,
          createdAt: new Date().toISOString()
        };

        await addDoc(collection(db, 'transactions'), transactionData);

        document.getElementById('transaction-amount').value = '';
        document.getElementById('transaction-category').value = '';
        document.getElementById('transaction-description').value = '';
        document.getElementById('transaction-date').valueAsDate = new Date();

        await loadTransactions(householdId);
        const currentMonth = new Date().toISOString().substring(0, 7);
        await loadCategorySpending(householdId, currentMonth);
        await updateBudgetDisplay(householdId, currentMonth);
        await updateDashboard(householdId, currentMonth);
      } catch (error) {
        errorDiv.textContent = 'Error adding transaction: ' + error.message;
        console.error('Error:', error);
      }
    });

    // Load transactions
    async function loadTransactions(householdId) {
      try {
        const q = query(
          collection(db, 'transactions'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);
        const transactionsList = document.getElementById('transactions-list');
        transactionsList.innerHTML = '';

        if (querySnapshot.empty) {
          transactionsList.innerHTML = '<p style="text-align: center; color: #666;">No transactions yet</p>';
          return;
        }

        // Convert to array and sort by date in JavaScript
        const transactions = [];
        querySnapshot.forEach((doc) => {
          transactions.push({ id: doc.id, ...doc.data() });
        });

        // Sort by date descending (most recent first)
        transactions.sort((a, b) => {
          const dateA = new Date(a.date);
          const dateB = new Date(b.date);
          return dateB - dateA;
        });

        // Display up to 20 most recent transactions
        transactions.slice(0, 20).forEach((transaction) => {
          const div = document.createElement('div');
          div.className = `transaction-item ${transaction.type}`;

          const sign = transaction.type === 'income' ? '+' : '-';
          const formattedDate = new Date(transaction.date).toLocaleDateString();

          div.innerHTML = `
            <div class="transaction-details">
              <div class="transaction-category">${transaction.category}</div>
              <div class="transaction-date">${formattedDate}${transaction.description ? ' â€¢ ' + transaction.description : ''}</div>
            </div>
            <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 5px;">
              <div class="transaction-amount ${transaction.type}">${sign}$${transaction.amount.toFixed(2)}</div>
              <div style="display: flex; gap: 5px;">
                <button class="delete-btn" style="background: #667eea; font-size: 11px; padding: 4px 8px;" onclick="editTransaction('${transaction.id}', '${transaction.type}', ${transaction.amount}, '${transaction.category}', '${transaction.description || ''}', '${transaction.date}')">Edit</button>
                <button class="delete-btn" style="font-size: 11px; padding: 4px 8px;" onclick="deleteTransaction('${transaction.id}')">Delete</button>
              </div>
            </div>
          `;

          transactionsList.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading transactions:', error);
        const transactionsList = document.getElementById('transactions-list');
        transactionsList.innerHTML = '<p style="text-align: center; color: #dc3545;">Error loading transactions. Check console for details.</p>';
      }
    }

    // Delete transaction
    window.deleteTransaction = async function(transactionId) {
      if (!confirm('Delete this transaction?')) return;

      try {
        await deleteDoc(doc(db, 'transactions', transactionId));

        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const householdId = userDoc.data().householdId;

        await loadTransactions(householdId);
        const currentMonth = new Date().toISOString().substring(0, 7);
        await loadCategorySpending(householdId, currentMonth);
        await updateBudgetDisplay(householdId, currentMonth);
        await updateDashboard(householdId, currentMonth);
      } catch (error) {
        console.error('Error deleting transaction:', error);
      }
    };

    // Edit transaction
    window.editTransaction = async function(transactionId, type, amount, category, description, date) {
      // Pre-fill the form with existing values
      document.getElementById('transaction-type').value = type;
      document.getElementById('transaction-amount').value = amount;
      document.getElementById('transaction-category').value = category;
      document.getElementById('transaction-description').value = description;
      document.getElementById('transaction-date').value = date;

      // Change button text to "Update Transaction"
      const addBtn = document.getElementById('add-transaction-btn');
      const originalText = addBtn.textContent;
      addBtn.textContent = 'Update Transaction';
      addBtn.style.background = '#28a745';

      // Store the transaction ID temporarily
      addBtn.dataset.editingId = transactionId;

      // Scroll to form
      document.getElementById('transactions').scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Update the click handler to update instead of add
      addBtn.onclick = async function() {
        const editingId = this.dataset.editingId;
        
        if (editingId) {
          // Update mode
          const type = document.getElementById('transaction-type').value;
          const amount = document.getElementById('transaction-amount').value;
          const category = document.getElementById('transaction-category').value;
          const description = document.getElementById('transaction-description').value;
          const date = document.getElementById('transaction-date').value;
          const errorDiv = document.getElementById('transaction-error');
          errorDiv.textContent = '';

          if (!amount || !category || !date) {
            errorDiv.textContent = 'Please fill in all required fields';
            return;
          }

          if (parseFloat(amount) <= 0) {
            errorDiv.textContent = 'Amount must be greater than 0';
            return;
          }

          try {
            const user = auth.currentUser;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const householdId = userDoc.data().householdId;

            const transactionData = {
              householdId: householdId,
              userId: user.uid,
              type: type,
              amount: parseFloat(amount),
              category: category,
              description: description,
              date: date,
              updatedAt: new Date().toISOString()
            };

            await setDoc(doc(db, 'transactions', editingId), transactionData, { merge: true });

            // Reset form
            document.getElementById('transaction-amount').value = '';
            document.getElementById('transaction-category').value = '';
            document.getElementById('transaction-description').value = '';
            document.getElementById('transaction-date').valueAsDate = new Date();

            // Reset button
            this.textContent = originalText;
            this.style.background = '';
            delete this.dataset.editingId;
            this.onclick = null; // Remove this handler

            await loadTransactions(householdId);
            const currentMonth = new Date().toISOString().substring(0, 7);
            await loadCategorySpending(householdId, currentMonth);
            await updateBudgetDisplay(householdId, currentMonth);
            await updateDashboard(householdId, currentMonth);
          } catch (error) {
            errorDiv.textContent = 'Error updating transaction: ' + error.message;
            console.error('Error:', error);
          }
        }
      };
    };

    // Load category spending
    let categoryPieChart = null; // Store chart instance globally
    
    async function loadCategorySpending(householdId, yearMonth) {
      try {
        const q = query(
          collection(db, 'transactions'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);

        const categoryTotals = {};
        let totalExpenses = 0;

        querySnapshot.forEach((doc) => {
          const transaction = doc.data();
          const transactionMonth = transaction.date.substring(0, 7);

          if (transactionMonth === yearMonth && transaction.type === 'expense') {
            if (!categoryTotals[transaction.category]) {
              categoryTotals[transaction.category] = 0;
            }
            categoryTotals[transaction.category] += transaction.amount;
            totalExpenses += transaction.amount;
          }
        });

        const chartDiv = document.getElementById('category-chart');
        const pieCanvas = document.getElementById('category-pie-chart');
        chartDiv.innerHTML = '';

        if (totalExpenses === 0) {
          chartDiv.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No expenses this month</p>';
          pieCanvas.style.display = 'none';
          if (categoryPieChart) {
            categoryPieChart.destroy();
            categoryPieChart = null;
          }
          return;
        }

        pieCanvas.style.display = 'block';

        const colors = [
          '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
          '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
        ];

        const sortedCategories = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

        // Create pie chart
        const labels = sortedCategories.map(([category]) => category);
        const data = sortedCategories.map(([, amount]) => amount);
        const backgroundColors = sortedCategories.map((_, index) => colors[index % colors.length]);

        // Destroy previous chart if it exists
        if (categoryPieChart) {
          categoryPieChart.destroy();
        }

        // Create new pie chart
        const ctx = pieCanvas.getContext('2d');
        categoryPieChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: labels,
            datasets: [{
              data: data,
              backgroundColor: backgroundColors,
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false // We'll use our custom legend below
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const percentage = ((value / totalExpenses) * 100).toFixed(1);
                    return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });

        // Create legend below chart
        sortedCategories.forEach(([category, amount], index) => {
          const percentage = (amount / totalExpenses) * 100;
          const color = colors[index % colors.length];

          const legendItem = document.createElement('div');
          legendItem.className = 'legend-item';
          legendItem.innerHTML = `
            <div style="display: flex; align-items: center;">
              <div class="legend-color" style="background: ${color};"></div>
              <span class="legend-label">${category}</span>
            </div>
            <div>
              <span class="legend-amount">$${amount.toFixed(2)}</span>
              <span class="legend-percentage">${percentage.toFixed(1)}%</span>
            </div>
          `;

          chartDiv.appendChild(legendItem);
        });
      } catch (error) {
        console.error('Error loading category spending:', error);
      }
    }

    // Add recurring bill
    document.getElementById('add-bill-btn').addEventListener('click', async () => {
      const name = document.getElementById('bill-name').value;
      const amount = document.getElementById('bill-amount').value;
      const category = document.getElementById('bill-category').value;
      const dayOfMonth = document.getElementById('bill-day').value;
      const errorDiv = document.getElementById('bill-error');
      errorDiv.textContent = '';

      if (!name || !amount || !category || !dayOfMonth) {
        errorDiv.textContent = 'Please fill in all fields';
        return;
      }

      if (parseFloat(amount) <= 0) {
        errorDiv.textContent = 'Amount must be greater than 0';
        return;
      }

      const day = parseInt(dayOfMonth);
      if (day < 1 || day > 31) {
        errorDiv.textContent = 'Day must be between 1 and 31';
        return;
      }

      try {
        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const householdId = userDoc.data().householdId;

        const billData = {
          householdId: householdId,
          name: name,
          amount: parseFloat(amount),
          category: category,
          dayOfMonth: day,
          createdBy: user.uid,
          createdAt: new Date().toISOString()
        };

        await addDoc(collection(db, 'recurringBills'), billData);

        document.getElementById('bill-name').value = '';
        document.getElementById('bill-amount').value = '';
        document.getElementById('bill-category').value = '';
        document.getElementById('bill-day').value = '';

        await loadRecurringBills(householdId);
        await autoCreateRecurringBills(householdId);
        const currentMonth = new Date().toISOString().substring(0, 7);
        await updateDashboard(householdId, currentMonth);
      } catch (error) {
        errorDiv.textContent = 'Error adding bill: ' + error.message;
        console.error('Error:', error);
      }
    });

    // Load recurring bills
    async function loadRecurringBills(householdId) {
      try {
        const q = query(
          collection(db, 'recurringBills'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);
        const billsList = document.getElementById('recurring-bills-list');
        billsList.innerHTML = '';

        if (querySnapshot.empty) {
          billsList.innerHTML = '<p style="text-align: center; color: #666;">No recurring bills yet</p>';
          return;
        }

        const today = new Date();
        const currentDay = today.getDate();

        querySnapshot.forEach((doc) => {
          const bill = doc.data();
          const div = document.createElement('div');
          div.className = 'bill-item';

          const daysUntilDue = bill.dayOfMonth - currentDay;
          let dueText = '';
          
          if (daysUntilDue < 0) {
            dueText = 'Next month';
          } else if (daysUntilDue === 0) {
            dueText = 'Due today';
            div.classList.add('due-soon');
          } else if (daysUntilDue <= 7) {
            dueText = `Due in ${daysUntilDue} day${daysUntilDue > 1 ? 's' : ''}`;
            div.classList.add('due-soon');
          } else {
            dueText = `Due on day ${bill.dayOfMonth}`;
          }

          div.innerHTML = `
            <div>
              <div class="bill-name">${bill.name}</div>
              <div class="bill-info">${bill.category}</div>
              <div class="bill-due">${dueText}</div>
            </div>
            <div style="text-align: right;">
              <div class="bill-amount">$${bill.amount.toFixed(2)}</div>
              <div style="display: flex; gap: 5px; margin-top: 5px; justify-content: flex-end;">
                <button class="delete-btn" style="background: #667eea; font-size: 11px; padding: 4px 8px;" onclick="editBill('${doc.id}', '${bill.name}', ${bill.amount}, '${bill.category}', ${bill.dayOfMonth})">Edit</button>
                <button class="delete-btn" style="font-size: 11px; padding: 4px 8px;" onclick="deleteBill('${doc.id}')">Delete</button>
              </div>
            </div>
          `;

          billsList.appendChild(div);
        });
      } catch (error) {
        console.error('Error loading recurring bills:', error);
      }
    }

    // Delete recurring bill
    window.deleteBill = async function(billId) {
      if (!confirm('Delete this recurring bill?')) return;

      try {
        await deleteDoc(doc(db, 'recurringBills', billId));

        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const householdId = userDoc.data().householdId;

        await loadRecurringBills(householdId);
        const currentMonth = new Date().toISOString().substring(0, 7);
        await updateDashboard(householdId, currentMonth);
      } catch (error) {
        console.error('Error deleting bill:', error);
      }
    };

    // Edit recurring bill
    window.editBill = async function(billId, name, amount, category, dayOfMonth) {
      // Pre-fill the form with existing values
      document.getElementById('bill-name').value = name;
      document.getElementById('bill-amount').value = amount;
      document.getElementById('bill-category').value = category;
      document.getElementById('bill-day').value = dayOfMonth;

      // Change button text to "Update Bill"
      const addBtn = document.getElementById('add-bill-btn');
      const originalText = addBtn.textContent;
      addBtn.textContent = 'Update Bill';
      addBtn.style.background = '#28a745';

      // Store the bill ID temporarily
      addBtn.dataset.editingId = billId;

      // Scroll to form
      document.getElementById('bills').scrollIntoView({ behavior: 'smooth', block: 'start' });

      // Update the click handler to update instead of add
      addBtn.onclick = async function() {
        const editingId = this.dataset.editingId;
        
        if (editingId) {
          // Update mode
          const name = document.getElementById('bill-name').value;
          const amount = document.getElementById('bill-amount').value;
          const category = document.getElementById('bill-category').value;
          const dayOfMonth = document.getElementById('bill-day').value;
          const errorDiv = document.getElementById('bill-error');
          errorDiv.textContent = '';

          if (!name || !amount || !category || !dayOfMonth) {
            errorDiv.textContent = 'Please fill in all fields';
            return;
          }

          if (parseFloat(amount) <= 0) {
            errorDiv.textContent = 'Amount must be greater than 0';
            return;
          }

          const day = parseInt(dayOfMonth);
          if (day < 1 || day > 31) {
            errorDiv.textContent = 'Day must be between 1 and 31';
            return;
          }

          try {
            const user = auth.currentUser;
            const userDoc = await getDoc(doc(db, 'users', user.uid));
            const householdId = userDoc.data().householdId;

            const billData = {
              householdId: householdId,
              name: name,
              amount: parseFloat(amount),
              category: category,
              dayOfMonth: day,
              updatedAt: new Date().toISOString()
            };

            await setDoc(doc(db, 'recurringBills', editingId), billData, { merge: true });

            // Reset form
            document.getElementById('bill-name').value = '';
            document.getElementById('bill-amount').value = '';
            document.getElementById('bill-category').value = '';
            document.getElementById('bill-day').value = '';

            // Reset button
            this.textContent = originalText;
            this.style.background = '';
            delete this.dataset.editingId;
            this.onclick = null; // Remove this handler

            await loadRecurringBills(householdId);
            await autoCreateRecurringBills(householdId);
            const currentMonth = new Date().toISOString().substring(0, 7);
            await updateDashboard(householdId, currentMonth);
          } catch (error) {
            errorDiv.textContent = 'Error updating bill: ' + error.message;
            console.error('Error:', error);
          }
        }
      };
    };

    // Auto-create recurring bills as transactions
    async function autoCreateRecurringBills(householdId) {
      try {
        const q = query(
          collection(db, 'recurringBills'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);
        const today = new Date();
        const currentMonth = today.toISOString().substring(0, 7);

        for (const billDoc of querySnapshot.docs) {
          const bill = billDoc.data();
          const billDate = `${currentMonth}-${String(bill.dayOfMonth).padStart(2, '0')}`;

          const transactionQuery = query(
            collection(db, 'transactions'),
            where('householdId', '==', householdId),
            where('date', '==', billDate),
            where('category', '==', bill.category),
            where('amount', '==', bill.amount)
          );

          const existingTransactions = await getDocs(transactionQuery);

          if (existingTransactions.empty && today.getDate() >= bill.dayOfMonth) {
            const transactionData = {
              householdId: householdId,
              userId: bill.createdBy,
              type: 'expense',
              amount: bill.amount,
              category: bill.category,
              description: `${bill.name} (auto)`,
              date: billDate,
              createdAt: new Date().toISOString(),
              isRecurring: true
            };

            await addDoc(collection(db, 'transactions'), transactionData);
          }
        }
      } catch (error) {
        console.error('Error auto-creating bills:', error);
      }
    }

    // Load budget
    async function loadBudget(householdId) {
      try {
        const q = query(
          collection(db, 'budgets'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          const budgetDoc = querySnapshot.docs[0];
          currentBudget = { id: budgetDoc.id, ...budgetDoc.data() };

          document.getElementById('budget-overview').classList.remove('hidden');
          document.getElementById('budget-setup-form').classList.add('hidden');
        } else {
          currentBudget = null;
          document.getElementById('budget-overview').classList.add('hidden');
          document.getElementById('budget-setup-form').classList.remove('hidden');
          await populateCategoryBudgetInputs();
        }
      } catch (error) {
        console.error('Error loading budget:', error);
      }
    }

    // Populate category budget inputs
    async function populateCategoryBudgetInputs() {
      const container = document.getElementById('category-budget-inputs');
      container.innerHTML = '';

      const categories = ['groceries', 'dining', 'utilities', 'rent', 'transportation',
                         'entertainment', 'healthcare', 'shopping', 'subscriptions', 'other'];

      categories.forEach(category => {
        const div = document.createElement('div');
        div.style.marginBottom = '10px';
        div.innerHTML = `
          <label style="display: block; font-size: 14px; margin-bottom: 3px; text-transform: capitalize;">${category}</label>
          <input type="number" 
                 id="budget-${category}" 
                 placeholder="Optional limit" 
                 step="0.01" 
                 style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; box-sizing: border-box;">
        `;
        container.appendChild(div);
      });
    }

    // Save budget
    document.getElementById('save-budget-btn').addEventListener('click', async () => {
      const income = document.getElementById('budget-income').value;
      const errorDiv = document.getElementById('budget-error');
      errorDiv.textContent = '';

      if (!income || parseFloat(income) <= 0) {
        errorDiv.textContent = 'Please enter a valid monthly income';
        return;
      }

      try {
        const user = auth.currentUser;
        const userDoc = await getDoc(doc(db, 'users', user.uid));
        const householdId = userDoc.data().householdId;

        const categoryLimits = {};
        const categories = ['groceries', 'dining', 'utilities', 'rent', 'transportation',
                           'entertainment', 'healthcare', 'shopping', 'subscriptions', 'other'];

        categories.forEach(category => {
          const value = document.getElementById(`budget-${category}`).value;
          if (value && parseFloat(value) > 0) {
            categoryLimits[category] = parseFloat(value);
          }
        });

        const budgetData = {
          householdId: householdId,
          income: parseFloat(income),
          categoryLimits: categoryLimits,
          createdBy: user.uid,
          updatedAt: new Date().toISOString()
        };

        if (currentBudget) {
          await setDoc(doc(db, 'budgets', currentBudget.id), budgetData);
        } else {
          await addDoc(collection(db, 'budgets'), budgetData);
        }

        await loadBudget(householdId);
        const currentMonth = new Date().toISOString().substring(0, 7);
        await updateBudgetDisplay(householdId, currentMonth);
        await updateDashboard(householdId, currentMonth);
      } catch (error) {
        errorDiv.textContent = 'Error saving budget: ' + error.message;
        console.error('Error:', error);
      }
    });

    // Edit budget button
    document.getElementById('edit-budget-btn').addEventListener('click', async () => {
      if (currentBudget) {
        document.getElementById('budget-income').value = currentBudget.income;

        await populateCategoryBudgetInputs();

        Object.entries(currentBudget.categoryLimits || {}).forEach(([category, limit]) => {
          const input = document.getElementById(`budget-${category}`);
          if (input) {
            input.value = limit;
          }
        });
      }

      document.getElementById('budget-overview').classList.add('hidden');
      document.getElementById('budget-setup-form').classList.remove('hidden');
    });

    // Update budget display
    async function updateBudgetDisplay(householdId, yearMonth) {
      if (!currentBudget) {
        return;
      }

      try {
        const q = query(
          collection(db, 'transactions'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);

        let totalIncome = 0;
        let totalExpenses = 0;
        const categorySpending = {};

        querySnapshot.forEach((doc) => {
          const transaction = doc.data();
          const transactionMonth = transaction.date.substring(0, 7);

          if (transactionMonth === yearMonth) {
            if (transaction.type === 'income') {
              totalIncome += transaction.amount;
            } else if (transaction.type === 'expense') {
              totalExpenses += transaction.amount;
              if (!categorySpending[transaction.category]) {
                categorySpending[transaction.category] = 0;
              }
              categorySpending[transaction.category] += transaction.amount;
            }
          }
        });

        const budgetIncome = currentBudget.income;
        const leftover = budgetIncome - totalExpenses;
        const spentPercentage = (totalExpenses / budgetIncome) * 100;

        document.getElementById('budget-income-display').textContent = `$${budgetIncome.toFixed(2)}`;
        document.getElementById('budget-spending-display').textContent = `$${totalExpenses.toFixed(2)}`;
        document.getElementById('budget-leftover-display').textContent = `$${leftover.toFixed(2)}`;
        document.getElementById('budget-leftover-display').style.color = leftover >= 0 ? '#28a745' : '#dc3545';

        const overallBar = document.getElementById('overall-budget-bar');
        const percentage = Math.min(spentPercentage, 100);
        overallBar.style.width = `${percentage}%`;

        if (spentPercentage < 80) {
          overallBar.className = 'budget-progress-fill good';
        } else if (spentPercentage < 100) {
          overallBar.className = 'budget-progress-fill warning';
        } else {
          overallBar.className = 'budget-progress-fill over';
        }

        document.getElementById('overall-budget-percentage').textContent = `${spentPercentage.toFixed(1)}%`;

        const categoryLimits = currentBudget.categoryLimits || {};
        const categoryBudgetsList = document.getElementById('category-budgets-list');

        if (Object.keys(categoryLimits).length === 0) {
          categoryBudgetsList.innerHTML = '<p style="text-align: center; color: #666;">No category budgets set</p>';
        } else {
          categoryBudgetsList.innerHTML = '';

          Object.entries(categoryLimits).forEach(([category, limit]) => {
            const spent = categorySpending[category] || 0;
            const percentageUsed = (spent / limit) * 100;

            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'budget-category-item';

            let statusClass = 'good';
            if (percentageUsed >= 100) {
              statusClass = 'over';
            } else if (percentageUsed >= 80) {
              statusClass = 'warning';
            }

            categoryDiv.innerHTML = `
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span style="text-transform: capitalize; font-weight: bold;">${category}</span>
                <span style="font-size: 14px;">$${spent.toFixed(2)} / $${limit.toFixed(2)}</span>
              </div>
              <div class="budget-progress-bar">
                <div class="budget-progress-fill ${statusClass}" style="width: ${Math.min(percentageUsed, 100)}%"></div>
              </div>
              <div style="font-size: 11px; color: #666; margin-top: 3px;">${percentageUsed.toFixed(1)}% used</div>
            `;

            categoryBudgetsList.appendChild(categoryDiv);
          });
        }
      } catch (error) {
        console.error('Error updating budget display:', error);
      }
    }

    // Update dashboard
    async function updateDashboard(householdId, yearMonth) {
      try {
        const q = query(
          collection(db, 'transactions'),
          where('householdId', '==', householdId)
        );

        const querySnapshot = await getDocs(q);

        let totalExpenses = 0;
        let fixedBills = 0;
        let discretionary = 0;

        const fixedCategories = ['rent', 'utilities', 'subscriptions'];

        querySnapshot.forEach((doc) => {
          const transaction = doc.data();
          const transactionMonth = transaction.date.substring(0, 7);

          if (transactionMonth === yearMonth && transaction.type === 'expense') {
            totalExpenses += transaction.amount;

            if (fixedCategories.includes(transaction.category)) {
              fixedBills += transaction.amount;
            } else {
              discretionary += transaction.amount;
            }
          }
        });

        document.getElementById('dashboard-fixed-bills').textContent = `$${fixedBills.toFixed(2)}`;
        document.getElementById('dashboard-discretionary').textContent = `$${discretionary.toFixed(2)}`;

        if (currentBudget) {
          const budgetIncome = currentBudget.income;
          const leftover = budgetIncome - totalExpenses;
          const spentPercentage = (totalExpenses / budgetIncome) * 100;

          document.getElementById('dashboard-income').textContent = `$${budgetIncome.toFixed(2)}`;
          document.getElementById('dashboard-leftover').textContent = `$${leftover.toFixed(2)}`;
          document.getElementById('dashboard-leftover').style.color = leftover >= 0 ? '#28a745' : '#dc3545';

          const progressBar = document.getElementById('dashboard-progress-bar');
          const percentage = Math.min(spentPercentage, 100);
          progressBar.style.width = `${percentage}%`;

          if (spentPercentage < 80) {
            progressBar.className = 'budget-progress-fill good';
          } else if (spentPercentage < 100) {
            progressBar.className = 'budget-progress-fill warning';
          } else {
            progressBar.className = 'budget-progress-fill over';
          }

          document.getElementById('dashboard-progress-text').textContent = `${spentPercentage.toFixed(1)}% spent`;
        } else {
          document.getElementById('dashboard-income').textContent = '$0';
          document.getElementById('dashboard-leftover').textContent = '$0';
          document.getElementById('dashboard-progress-bar').style.width = '0%';
          document.getElementById('dashboard-progress-text').textContent = 'No budget set';
        }

        // Update upcoming bills preview
        const billsQuery = query(
          collection(db, 'recurringBills'),
          where('householdId', '==', householdId)
        );

        const billsSnapshot = await getDocs(billsQuery);
        const upcomingBillsDiv = document.getElementById('upcoming-bills-preview');
        upcomingBillsDiv.innerHTML = '';

        if (billsSnapshot.empty) {
          upcomingBillsDiv.innerHTML = '<p style="text-align: center; color: #666;">No recurring bills</p>';
        } else {
          const today = new Date();
          const currentDay = today.getDate();
          const upcomingBills = [];

          billsSnapshot.forEach((doc) => {
            const bill = doc.data();
            const daysUntilDue = bill.dayOfMonth - currentDay;

            if (daysUntilDue >= 0 && daysUntilDue <= 7) {
              upcomingBills.push({ ...bill, daysUntilDue });
            }
          });

          upcomingBills.sort((a, b) => a.daysUntilDue - b.daysUntilDue);

          if (upcomingBills.length === 0) {
            upcomingBillsDiv.innerHTML = '<p style="text-align: center; color: #666;">No bills due in the next 7 days</p>';
          } else {
            upcomingBills.slice(0, 3).forEach(bill => {
              const div = document.createElement('div');
              div.className = 'bill-item due-soon';
              div.style.marginBottom = '10px';

              const dueText = bill.daysUntilDue === 0 ? 'Due today' : `Due in ${bill.daysUntilDue} day${bill.daysUntilDue > 1 ? 's' : ''}`;

              div.innerHTML = `
                <div>
                  <div class="bill-name">${bill.name}</div>
                  <div class="bill-due">${dueText}</div>
                </div>
                <div class="bill-amount">$${bill.amount.toFixed(2)}</div>
              `;

              upcomingBillsDiv.appendChild(div);
            });
          }
        }
      } catch (error) {
        console.error('Error updating dashboard:', error);
      }
    }

    // Listen for auth state changes
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const householdId = await getUserHousehold(user.uid);

        if (householdId) {
          const householdData = await loadHouseholdData(householdId);

          signupForm.classList.add('hidden');
          loginForm.classList.add('hidden');
          householdSetup.classList.add('hidden');
          createHouseholdForm.classList.add('hidden');
          joinHouseholdForm.classList.add('hidden');
          mainApp.classList.remove('hidden');

          if (householdData) {
            document.getElementById('current-household-name').textContent = householdData.name;
            document.getElementById('household-invite-code').textContent = householdData.inviteCode;
          }

          await autoCreateRecurringBills(householdId);

          const currentMonth = new Date().toISOString().substring(0, 7);
          await loadTransactions(householdId);
          await loadCategorySpending(householdId, currentMonth);
          await loadRecurringBills(householdId);
          await loadBudget(householdId);
          await updateBudgetDisplay(householdId, currentMonth);
          await updateDashboard(householdId, currentMonth);
        } else {
          signupForm.classList.add('hidden');
          loginForm.classList.add('hidden');
          householdSetup.classList.remove('hidden');
          createHouseholdForm.classList.add('hidden');
          joinHouseholdForm.classList.add('hidden');
          mainApp.classList.add('hidden');
        }

        console.log('User authenticated:', user.uid);
      } else {
        signupForm.classList.remove('hidden');
        loginForm.classList.add('hidden');
        householdSetup.classList.add('hidden');
        createHouseholdForm.classList.add('hidden');
        joinHouseholdForm.classList.add('hidden');
        mainApp.classList.add('hidden');
      }
    });
  </script>

</body>
</html>
